{% extends "core/base.html" %}

{% block title %}Финансовый отчет{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-currency-dollar"></i> Финансовый отчет</h1>
    <div>
        <a href="{% url 'core:index' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> На главную
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5 class="card-title">Доход за сегодня</h5>
                <h2 class="display-4">{{ today_revenue }} ₸</h2>
                <p class="card-text">{{ today_date|date:'d.m.Y' }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h5 class="card-title">Доход за 30 дней</h5>
                <h2 class="display-4">{{ recent_revenue }} ₸</h2>
                <p class="card-text">с {{ thirty_days_ago|date:'d.m.Y' }} по {{ today_date|date:'d.m.Y' }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">Доходы по типам абонементов за 30 дней</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Тип абонемента</th>
                        <th>Уникальных клиентов</th>
                        <th>Доход за 30 дней</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in revenue_by_type %}
                    <tr class="clickable-row" data-type-id="{{ item.type__id }}" data-type-name="{{ item.type__name }}">
                        <td>
                            <a href="#" class="text-decoration-none subscription-type-link">
                                <i class="bi bi-people"></i> {{ item.type__name }}
                            </a>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ item.unique_clients }}</span>
                        </td>
                        <td>
                            <strong>{{ item.revenue_30_days|default:0 }} ₸</strong>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">Нет данных о продажах за последние 30 дней</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if revenue_by_type %}
                <tfoot>
                    <tr class="table-dark">
                        <th>ИТОГО</th>
                        <th>{{ total_clients_30_days }} клиентов</th>
                        <th><strong>{{ total_revenue_30_days }} ₸</strong></th>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения клиентов -->
<div class="modal fade" id="clientsModal" tabindex="-1" aria-labelledby="clientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientsModalLabel">Клиенты с абонементом: <span id="modalSubscriptionType"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="clientsList" class="table-responsive">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка данных...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <h6><i class="bi bi-info-circle"></i> Информация</h6>
    <p>Отчет показывает выручку от продажи абонементов за последние 30 дней. Нажмите на название типа абонемента чтобы увидеть список клиентов.</p>
</div>
{% endblock %}

{% block extra_css %}
<style>
.clickable-row:hover {
    background-color: rgba(13, 110, 253, 0.1);
    cursor: pointer;
}
.subscription-type-link {
    color: #0d6efd;
    font-weight: 500;
}
.subscription-type-link:hover {
    color: #0b5ed7;
    text-decoration: underline;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientsModal = new bootstrap.Modal(document.getElementById('clientsModal'));
    const modalTitle = document.getElementById('modalSubscriptionType');
    const clientsList = document.getElementById('clientsList');

    // Обработчик клика по названию абонемента
    document.querySelectorAll('.subscription-type-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const row = this.closest('tr');
            const typeId = row.getAttribute('data-type-id');
            const typeName = row.getAttribute('data-type-name');

            // Устанавливаем заголовок модального окна
            modalTitle.textContent = typeName;

            // Показываем спиннер загрузки
            clientsList.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
            `;

            // Открываем модальное окно
            clientsModal.show();

            // Загружаем данные клиентов
            loadClientsBySubscriptionType(typeId);
        });
    });

    // Функция загрузки клиентов по типу абонемента
    function loadClientsBySubscriptionType(typeId) {
        fetch(`/api/subscription-type/${typeId}/clients/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.clients && data.clients.length > 0) {
                    renderClientsList(data.clients);
                } else {
                    clientsList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-people" style="font-size: 3rem;"></i>
                            <p class="mt-2">Нет клиентов с данным типом абонемента</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                clientsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка загрузка данных
                    </div>
                `;
            });
    }

    // Функция отображения списка клиентов
    function renderClientsList(clients) {
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Клиент</th>
                            <th>Телефон</th>
                            <th>Email</th>
                            <th>Статус абонемента</th>
                            <th>Дата регистрации</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        clients.forEach(client => {
            html += `
                <tr>
                    <td>
                        <a href="/client/${client.id}/" class="text-decoration-none">
                            <strong>${client.last_name} ${client.first_name}</strong>
                        </a>
                    </td>
                    <td>${client.phone}</td>
                    <td>${client.email}</td>
                    <td>
                        <span class="badge bg-${client.is_active ? 'success' : 'secondary'}">
                            ${client.is_active ? 'Активен' : 'Неактивен'}
                        </span>
                    </td>
                    <td>${client.date_created}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> Всего клиентов: <strong>${clients.length}</strong>
                </div>
            </div>
        `;

        clientsList.innerHTML = html;
    }
});
</script>
{% endblock %}